resolver 127.0.0.11 valid=5s ipv6=off;

upstream auth_backend      { zone auth_backend_zone 64k;      least_conn; server auth-service:8080      resolve; keepalive 256; }
upstream product_backend   { zone product_backend_zone 64k;   least_conn; server product-service:8080   resolve; keepalive 256; }
upstream order_backend     { zone order_backend_zone 64k;     least_conn; server order-service:8080     resolve; keepalive 256; }
upstream cart_backend      { zone cart_backend_zone 64k;      least_conn; server cart-service:8080      resolve; keepalive 256; }
upstream payment_backend   { zone payment_backend_zone 64k;   least_conn; server payment-service:8080   resolve; keepalive 256; }
upstream inventory_backend { zone inventory_backend_zone 64k; least_conn; server inventory-service:8080 resolve; keepalive 256; }

proxy_cache_path /var/cache/nginx/products levels=1:2 keys_zone=products_cache:50m
                 max_size=256m inactive=2m use_temp_path=off;

server {
  listen 80;
  server_name _;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  location /api/auth {
    proxy_pass http://auth_backend;
    include /etc/nginx/conf.d/proxy_params;
  }

  location /api/products {
    proxy_pass http://product_backend;
    include /etc/nginx/conf.d/proxy_params;
    proxy_cache            products_cache;
    proxy_cache_methods    GET HEAD;
    proxy_cache_valid      200 304 60s;
    proxy_cache_use_stale  error timeout updating http_502 http_503 http_504;
    add_header X-Cache $upstream_cache_status;
  }

  location /api/orders {
    proxy_pass http://order_backend;
    include /etc/nginx/conf.d/proxy_params;
  }

  location /api/cart {
    proxy_pass http://cart_backend;
    include /etc/nginx/conf.d/proxy_params;
  }

  location /api/payments {
    proxy_pass http://payment_backend;
    include /etc/nginx/conf.d/proxy_params;
  }

  location /api/inventory {
    proxy_pass http://inventory_backend;
    include /etc/nginx/conf.d/proxy_params;
  }
}
