resolver 127.0.0.11 valid=5s ipv6=off;

upstream auth_backend      { zone auth_backend_zone 64k;      least_conn; server auth-service:8080      resolve; keepalive 64; }
upstream product_backend   { zone product_backend_zone 64k;   least_conn; server product-service:8080   resolve; keepalive 64; }
upstream order_backend     { zone order_backend_zone 64k;     least_conn; server order-service:8080     resolve; keepalive 64; }
upstream cart_backend      { zone cart_backend_zone 64k;      least_conn; server cart-service:8080      resolve; keepalive 64; }
upstream payment_backend   { zone payment_backend_zone 64k;   least_conn; server payment-service:8080   resolve; keepalive 64; }
upstream inventory_backend { zone inventory_backend_zone 64k; least_conn; server inventory-service:8080 resolve; keepalive 64; }

server {
  listen 80;
  server_name _;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  location /api/auth      { proxy_pass http://auth_backend;      include /etc/nginx/conf.d/proxy_params; }
  location /api/products  { proxy_pass http://product_backend;   include /etc/nginx/conf.d/proxy_params; }
  location /api/orders    { proxy_pass http://order_backend;     include /etc/nginx/conf.d/proxy_params; }
  location /api/cart      { proxy_pass http://cart_backend;      include /etc/nginx/conf.d/proxy_params; }
  location /api/payments  { proxy_pass http://payment_backend;   include /etc/nginx/conf.d/proxy_params; }
  location /api/inventory { proxy_pass http://inventory_backend; include /etc/nginx/conf.d/proxy_params; }
}
